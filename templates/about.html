{% extends 'base.html' %}
{% block title %}关于 - Prompt Manager{% endblock %}

{% block content %}
<div class="page-container" style="max-width: 800px;">

    <div class="text-center mb-5 animate-up">
        <div class="mb-3 d-inline-flex align-items-center justify-content-center shadow-sm"
             style="width: 80px; height: 80px; background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%); border-radius: 22px;">
            <i class="bi bi-images text-primary" style="font-size: 2.5rem; opacity: 0.8;"></i>
        </div>
        <h2 class="fw-bold mb-2" style="letter-spacing: -0.5px;">Prompt Manager</h2>
        <p class="text-secondary small">Local AI Art Collection & Workflow Tool</p>

        <div class="mt-3">
            <a href="https://github.com/vioaki/Prompt-Manager" target="_blank" class="btn btn-dark rounded-pill px-4 py-2 small fw-bold shadow-sm transition-transform hover-scale">
                <i class="bi bi-github me-2"></i>GitHub Repository
            </a>
        </div>
    </div>

    {% if config.ALLOW_PUBLIC_SENSITIVE_TOGGLE or current_user.is_authenticated %}
    <div class="glass-panel p-4 mb-5 animate-up" style="animation-delay: 0.1s;">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-3">
                <div class="rounded-circle d-flex align-items-center justify-content-center bg-warning bg-opacity-10 text-warning"
                     style="width: 48px; height: 48px; flex-shrink: 0;">
                    <i class="bi bi-eye-slash-fill fs-5"></i>
                </div>
                <div>
                    <h6 class="fw-bold mb-1">敏感内容展示 (NSFW)</h6>
                    <p class="text-secondary small mb-0 line-height-sm">
                        开启后，画廊将显示被标记为敏感的作品。
                    </p>
                    {% if not config.ALLOW_PUBLIC_SENSITIVE_TOGGLE and current_user.is_authenticated %}
                    <p class="text-danger x-small mb-0 mt-1 fw-bold">
                        * 全局开关已锁定，当前仅管理员可见此选项
                    </p>
                    {% endif %}
                </div>
            </div>

            <div class="form-check form-switch m-0">
                <input class="form-check-input ios-switch danger" type="checkbox" role="switch" id="sensitiveToggle">
            </div>
        </div>
    </div>
    {% endif %}

    <div class="glass-panel p-4 mb-5 animate-up" style="animation-delay: 0.2s;">
        <h5 class="fw-bold mb-4 art-title" style="font-size: 1.1rem;">快速使用指南</h5>
        <div class="row g-4">
            <div class="col-md-6">
                <div class="d-flex gap-3">
                    <div class="rounded-circle d-flex align-items-center justify-content-center bg-primary bg-opacity-10 text-primary"
                         style="width: 42px; height: 42px; flex-shrink: 0;">
                        <i class="bi bi-cloud-arrow-up-fill"></i>
                    </div>
                    <div>
                        <h6 class="fw-bold mb-1">上传与记录</h6>
                        <p class="text-secondary small mb-0 line-height-sm">
                            支持拖拽上传。对于 Img2Img 作品，可上传多张参考图并拖拽调整顺序。
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex gap-3">
                    <div class="rounded-circle d-flex align-items-center justify-content-center bg-success bg-opacity-10 text-success"
                         style="width: 42px; height: 42px; flex-shrink: 0;">
                        <i class="bi bi-search"></i>
                    </div>
                    <div>
                        <h6 class="fw-bold mb-1">检索与复用</h6>
                        <p class="text-secondary small mb-0 line-height-sm">
                            详情页一键复制 Prompt。支持通过标签组合或关键词快速筛选灵感。
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex gap-3">
                    <div class="rounded-circle d-flex align-items-center justify-content-center bg-danger bg-opacity-10 text-danger"
                         style="width: 42px; height: 42px; flex-shrink: 0;">
                        <i class="bi bi-shield-lock-fill"></i>
                    </div>
                    <div>
                        <h6 class="fw-bold mb-1">管理与审核</h6>
                        <p class="text-secondary small mb-0 line-height-sm">
                            所有作品默认“待审核”。管理员可登录后台进行发布、删除或数据备份。
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex gap-3">
                    <div class="rounded-circle d-flex align-items-center justify-content-center bg-info bg-opacity-10 text-info"
                         style="width: 42px; height: 42px; flex-shrink: 0;">
                        <i class="bi bi-database-down"></i>
                    </div>
                    <div>
                        <h6 class="fw-bold mb-1">数据主权</h6>
                        <p class="text-secondary small mb-0 line-height-sm">
                            完全本地化运行。支持 ZIP 格式一键全量备份与恢复，轻松迁移。
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="glass-panel p-4 mb-5 animate-up" style="animation-delay: 0.3s;">
        <div class="d-flex align-items-center justify-content-between mb-4">
            <h4 class="fw-bold art-title mb-0" style="font-size: 1.1rem;">开发者接口 (API)</h4>
        </div>

        <p class="text-secondary mb-4 small">
            本系统提供高性能 RESTful API，支持智能缓存与无限分页模式。<br>
            适用于构建第三方客户端、自动化脚本或集成到工作流中。
        </p>

        <div class="mb-4">
            <h6 class="fw-bold small text-secondary text-uppercase ls-1 mb-2">1. 画廊数据 (Gallery)</h6>
            <div class="input-glass rounded-3 p-3 d-flex align-items-center shadow-sm">
                <span class="badge bg-secondary me-3">GET</span>
                <code class="fw-bold flex-grow-1 text-break" style="font-family: 'SF Mono', monospace; color: var(--text-primary) !important;">
                    {{ url_for('public.api_gallery_list', _external=True) }}
                </code>
                <button class="btn btn-sm btn-outline-secondary border-0"
                        onclick="navigator.clipboard.writeText('{{ url_for('public.api_gallery_list', _external=True) }}'); alert('地址已复制')"
                        title="复制接口地址">
                    <i class="bi bi-clipboard"></i>
                </button>
            </div>
        </div>

        <div class="mb-5">
            <h6 class="fw-bold small text-secondary text-uppercase ls-1 mb-2">2. 模板数据 (Templates)</h6>
            <div class="input-glass rounded-3 p-3 d-flex align-items-center shadow-sm">
                <span class="badge bg-secondary me-3">GET</span>
                <code class="fw-bold flex-grow-1 text-break" style="font-family: 'SF Mono', monospace; color: var(--text-primary) !important;">
                    {{ url_for('public.api_templates_list', _external=True) }}
                </code>
                <button class="btn btn-sm btn-outline-secondary border-0"
                        onclick="navigator.clipboard.writeText('{{ url_for('public.api_templates_list', _external=True) }}'); alert('地址已复制')"
                        title="复制接口地址">
                    <i class="bi bi-clipboard"></i>
                </button>
            </div>
        </div>

        <h6 class="fw-bold text-secondary small text-uppercase mb-3 ps-1">请求参数 (Query Parameters)</h6>

        <div class="table-responsive input-glass rounded-3 mb-5 overflow-hidden">
            <table class="table table-sm small mb-0" style="--bs-table-bg: transparent;">
                <thead style="background-color: var(--btn-bg);">
                    <tr>
                        <th class="ps-3 py-3 border-bottom-0" style="width: 100px; color: var(--text-primary);">参数名</th>
                        <th class="py-3 border-bottom-0" style="width: 70px; color: var(--text-primary);">类型</th>
                        <th class="py-3 border-bottom-0" style="width: 100px; color: var(--text-primary);">默认值</th>
                        <th class="py-3 border-bottom-0" style="color: var(--text-primary);">描述与示例</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="ps-3 py-3 font-monospace fw-bold" style="color: var(--text-primary);">per_page</td>
                        <td class="py-3" style="color: var(--text-secondary);">Int</td>
                        <td class="py-3" style="color: var(--text-secondary);">500</td>
                        <td class="py-3" style="color: var(--text-secondary);">
                            每页数量。支持 <code class="px-1 rounded fw-bold" style="background:var(--btn-bg); color:var(--text-primary);">-1</code> 开启<span class="fw-bold" style="color: var(--text-primary);">无限模式</span>（获取全部，上限 1w）。
                        </td>
                    </tr>
                    <tr>
                        <td class="ps-3 py-3 font-monospace fw-bold" style="color: var(--text-primary);">page</td>
                        <td class="py-3" style="color: var(--text-secondary);">Int</td>
                        <td class="py-3" style="color: var(--text-secondary);">1</td>
                        <td class="py-3" style="color: var(--text-secondary);">分页页码。配合返回元数据中的 <code>meta.next_url</code> 可自动翻页。</td>
                    </tr>
                    <tr>
                        <td class="ps-3 py-3 font-monospace fw-bold" style="color: var(--text-primary);">q</td>
                        <td class="py-3" style="color: var(--text-secondary);">String</td>
                        <td class="py-3" style="color: var(--text-secondary);">Null</td>
                        <td class="py-3" style="color: var(--text-secondary);">关键词搜索（匹配标题、Prompt或作者）。<br>例: <code>?q=cyberpunk</code></td>
                    </tr>
                    <tr>
                        <td class="ps-3 py-3 font-monospace fw-bold" style="color: var(--text-primary);">tag</td>
                        <td class="py-3" style="color: var(--text-secondary);">String</td>
                        <td class="py-3" style="color: var(--text-secondary);">Null</td>
                        <td class="py-3" style="color: var(--text-secondary);">标签筛选。<br>例: <code>?tag=二次元</code></td>
                    </tr>
                    <tr>
                        <td class="ps-3 py-3 font-monospace fw-bold" style="color: var(--text-primary);">sort</td>
                        <td class="py-3" style="color: var(--text-secondary);">String</td>
                        <td class="py-3" style="color: var(--text-secondary);">date</td>
                        <td class="py-3" style="color: var(--text-secondary);">排序方式。可选值: <code>date</code> (最新), <code>hot</code> (热度), <code>random</code> (随机)。</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h6 class="fw-bold text-secondary small text-uppercase mb-3 ps-1">⚡️ 高级特性：ETag 缓存校验</h6>

        <div class="input-glass p-4 rounded-3 mb-5 border border-secondary border-opacity-10">
            <p class="small mb-4" style="color: var(--text-secondary);">
                为了节省带宽并提高轮询效率，API 实现了标准的 <strong>ETag / 304 Not Modified</strong> 机制。这允许客户端在数据未发生变化时，直接跳过下载过程。
            </p>

            <div class="d-flex flex-column gap-3">
                <div class="d-flex gap-3">
                    <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; font-size: 0.8rem; flex-shrink: 0;">1</div>
                    <div class="small text-secondary">
                        <strong style="color: var(--text-primary);">首次请求：</strong> 服务器返回完整数据，并在 Header 中附带一个唯一指纹：<br>
                        <code class="text-primary mt-1 d-inline-block">ETag: "68b329da9893e34099c7d8ad5cb9c940"</code>
                    </div>
                </div>

                <div class="d-flex gap-3">
                    <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; font-size: 0.8rem; flex-shrink: 0;">2</div>
                    <div class="small text-secondary">
                        <strong style="color: var(--text-primary);">后续请求：</strong> 客户端在 Header 中发送上次收到的指纹：<br>
                        <code class="text-primary mt-1 d-inline-block">If-None-Match: "68b329da9893e34099c7d8ad5cb9c940"</code>
                    </div>
                </div>

                <div class="d-flex gap-3">
                    <div class="rounded-circle bg-success bg-opacity-10 text-success d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; font-size: 0.8rem; flex-shrink: 0;">3</div>
                    <div class="small text-secondary">
                        <strong style="color: var(--text-primary);">极速响应：</strong> 如果库中数据没有变化（哈希一致），服务器将直接返回 <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">304 Not Modified</span> 状态码，且 <strong>不返回任何数据包体</strong> (Body Length = 0)。
                    </div>
                </div>
            </div>
        </div>

        <h6 class="fw-bold text-secondary small text-uppercase mb-3 ps-1">响应示例 (Response Structure)</h6>
        <div class="bg-dark text-white p-3 rounded-3 shadow-sm position-relative group border border-secondary border-opacity-25">
            <button class="btn btn-sm btn-dark position-absolute top-0 end-0 m-2 border border-secondary border-opacity-25"
                    onclick="copyCode(this)" style="font-size: 0.7rem;">Copy JSON</button>

            <pre class="m-0 custom-scrollbar" style="font-family: 'SF Mono', monospace; font-size: 0.8rem; color: #a5d6ff; max-height: 400px; overflow-y: auto;">{
  "code": 200,
  "message": "success",
  "meta": {
    "page": 1,
    "per_page": 500,
    "total_items": 1280,
    "total_pages": 3,
    "has_next": true,
    "next_url": "https://.../api/gallery?page=2&per_page=500",
    "server_timestamp": 1715421000
  },
  "data": [
    {
      "id": 1024,
      "title": "Only the flowers know Ver.2",
      "author": "vioaki",
      "type": "img2img",
      "file_path": "https://example.com/static/uploads/uuid.jpg",
      "thumbnail_path": "https://example.com/static/uploads/uuid_thumb.jpg",
      "prompt": "This is a masterpiece...",
      "refs": [
         {
           "position": 0,
           "is_placeholder": false,
           "file_path": "https://example.com/static/uploads/ref1.jpg"
         }
      ],
      "tags": ["banana", "violet"],
      "heat_score": 52,
      "created_at": "2025-12-10T10:00:00"
    },
    // ... more items ...
  ]
}</pre>
        </div>
    </div>
</div>

<style>
    .hover-scale:hover { transform: scale(1.05); }
    .transition-transform { transition: transform 0.2s ease; }
    .line-height-sm { line-height: 1.5; }

    /* 修复 input-glass 内表格边框颜色，防止在黑暗模式下太亮 */
    .input-glass .table>:not(caption)>*>* {
        border-bottom-color: rgba(128,128,128,0.1);
    }
</style>

<script>
(function () {
    const COOKIE_NAME = 'pm_show_sensitive';
    const toggle = document.getElementById('sensitiveToggle');
    if (toggle) {
        const isEnabled = document.cookie.split('; ').find(row => row.startsWith(COOKIE_NAME + '='))?.split('=')[1] === '1';
        toggle.checked = isEnabled;
        toggle.addEventListener('change', function() {
            const d = new Date();
            d.setTime(d.getTime() + (30 * 24 * 60 * 60 * 1000));
            document.cookie = `${COOKIE_NAME}=${toggle.checked ? '1' : '0'};expires=${d.toUTCString()};path=/`;
            setTimeout(() => window.location.reload(), 300);
        });
    }
})();

function copyCode(btn) {
    const pre = btn.nextElementSibling;
    navigator.clipboard.writeText(pre.textContent).then(() => {
        const original = btn.innerText;
        btn.innerText = "Copied!";
        setTimeout(() => btn.innerText = original, 2000);
    });
}
</script>
{% endblock %}